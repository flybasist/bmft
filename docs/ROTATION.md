# üîÑ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```bash
# –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ (lumberjack)
LOG_MAX_SIZE_MB=100        # –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (MB) –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π
LOG_MAX_BACKUPS=3          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä—Ö–∏–≤–æ–≤
LOG_MAX_AGE_DAYS=28        # –í–æ–∑—Ä–∞—Å—Ç –∞—Ä—Ö–∏–≤–æ–≤ (–¥–Ω–∏)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL –ø–∞—Ä—Ç–∏—Ü–∏–∏)
DB_RETENTION_MONTHS=6      # –•—Ä–∞–Ω–µ–Ω–∏–µ event_log (–º–µ—Å—è—Ü—ã)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ:**

| –ù–∞–≥—Ä—É–∑–∫–∞ | SIZE | BACKUPS | AGE | RETENTION |
|----------|------|---------|-----|-----------|
| –ú–∞–ª–∞—è (<1k msg/day) | 50 | 2 | 14 | 3 |
| –°—Ä–µ–¥–Ω—è—è (1k-10k) | 100 | 3 | 28 | 6 |
| –í—ã—Å–æ–∫–∞—è (>10k) | 200 | 5 | 30 | 12 |

---

## üìÅ –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** [lumberjack.v2](https://github.com/natefinch/lumberjack)
- **–ü—É—Ç—å:** `logs/bot.log`
- **–°–∂–∞—Ç–∏–µ:** gzip –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–†–æ—Ç–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–≥–¥–∞:**
1. –§–∞–π–ª –¥–æ—Å—Ç–∏–≥–∞–µ—Ç `LOG_MAX_SIZE_MB` ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞—Ä—Ö–∏–≤ `.gz`
2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä—Ö–∏–≤–æ–≤ > `LOG_MAX_BACKUPS` ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä–µ–π—à–∏–π
3. –ê—Ä—Ö–∏–≤ —Å—Ç–∞—Ä—à–µ `LOG_MAX_AGE_DAYS` ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
logs/
‚îú‚îÄ‚îÄ bot.log                              # –ê–∫—Ç–∏–≤–Ω—ã–π –ª–æ–≥
‚îú‚îÄ‚îÄ bot.log.2025-01-14T10-30-00.000.gz  # –ê—Ä—Ö–∏–≤
‚îú‚îÄ‚îÄ bot.log.2025-01-13T09-15-30.000.gz
‚îî‚îÄ‚îÄ bot.log.2025-01-12T08-45-15.000.gz
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```bash
ls -lh logs/                  # –í—Å–µ —Ñ–∞–π–ª—ã
du -sh logs/                  # –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```

---

## üóÑÔ∏è –ü–∞—Ä—Ç–∏—Ü–∏–∏ PostgreSQL

### –¢–∞–±–ª–∏—Ü–∞ event_log

`event_log` —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ –º–µ—Å—è—á–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏:

```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–æ—É—Ç–∏—Ç—Å—è –ø–æ created_at
event_log_2025_10    # –û–∫—Ç—è–±—Ä—å 2025
event_log_2025_11    # –ù–æ—è–±—Ä—å 2025
event_log_2025_12    # –î–µ–∫–∞–±—Ä—å 2025
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å–∫–∞–Ω–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –º–µ—Å—è—Ü—ã)
- üóëÔ∏è –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (`DROP TABLE`)
- üíæ –ü—Ä–æ—Å—Ç—ã–µ –±—ç–∫–∞–ø—ã –ø–æ –º–µ—Å—è—Ü–∞–º

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–ú–æ–¥—É–ª—å Maintenance** (—Ñ–æ–Ω–æ–≤—ã–π cron):

| –í—Ä–µ–º—è | –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|--------|----------|
| 03:00 | –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π | –ù–∞ 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥ |
| 04:00 | –£–¥–∞–ª–µ–Ω–∏–µ | –°—Ç–∞—Ä—à–µ `DB_RETENTION_MONTHS` |

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```sql
-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) as size
FROM pg_tables 
WHERE schemaname='public' AND tablename LIKE 'event_log_%'
ORDER BY tablename DESC;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
SELECT COUNT(*) FROM event_log_2025_11;
```

```bash
# –õ–æ–≥–∏ –º–æ–¥—É–ª—è Maintenance
grep "maintenance module started" logs/bot.log
grep "partition already exists or created" logs/bot.log
grep "dropped old partition" logs/bot.log
```

---

## üö® Troubleshooting

### –õ–æ–≥-—Ñ–∞–π–ª –Ω–µ —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
ls -ld logs/
chmod 755 logs/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker compose restart bot
```

### –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

```sql
-- –°–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–Ω–≤–∞—Ä—å 2026)
CREATE TABLE IF NOT EXISTS event_log_2026_01 
PARTITION OF event_log
FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Maintenance
grep "ensurePartitions" logs/bot.log
```

### –°—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
grep DB_RETENTION_MONTHS .env

# –£–¥–∞–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é (–í–ù–ò–ú–ê–ù–ò–ï: –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è!)
docker exec bmft_postgres psql -U bmft -d bmft \
  -c "DROP TABLE IF EXISTS event_log_2024_06;"
```

### –õ–æ–≥–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞

```bash
# –£–º–µ–Ω—å—à–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
echo "LOG_MAX_BACKUPS=2" >> .env
echo "LOG_MAX_AGE_DAYS=14" >> .env

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –≤—Ä—É—á–Ω—É—é
find logs/ -name "bot.log.*.gz" -mtime +30 -delete

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker compose restart bot
```

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ event_log

```sql
-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
DROP TABLE IF EXISTS event_log_2024_06;
DROP TABLE IF EXISTS event_log_2024_07;

-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
REINDEX TABLE event_log;

-- VACUUM
VACUUM ANALYZE event_log;
```

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- [DATABASE.md](../architecture/DATABASE.md) ‚Äî –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [MODULES.md](../modules/MODULES.md) ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è Maintenance
