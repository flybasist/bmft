# üîÑ –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ —Ä–∞–±–æ—Ç–µ —Å —Å–∏—Å—Ç–µ–º–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö –≤ BMFT.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤](#—Ä–æ—Ç–∞—Ü–∏—è-—Ñ–∞–π–ª–æ–≤-–ª–æ–≥–æ–≤)
3. [–†–æ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL](#—Ä–æ—Ç–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö-–≤-postgresql)
4. [–ú–æ–¥—É–ª—å Maintenance](#–º–æ–¥—É–ª—å-maintenance)
5. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
6. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
7. [Troubleshooting](#troubleshooting)

---

## –û–±–∑–æ—Ä

BMFT —Ä–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ä–æ—Ç–∞—Ü–∏–∏:

### üóÇÔ∏è –§–∞–π–ª–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è (lumberjack)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É —Ñ–∞–π–ª–∞
- –°–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (gzip)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É

### üóÑÔ∏è –†–æ—Ç–∞—Ü–∏—è –ë–î (–ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ PostgreSQL)
- –ú–µ—Å—è—á–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è `event_log`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

### –ú–µ—Ö–∞–Ω–∏–∑–º

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [lumberjack.v2](https://github.com/natefinch/lumberjack):

```go
&lumberjack.Logger{
    Filename:   "logs/bot.log",
    MaxSize:    100,           // MB
    MaxBackups: 3,             // —Ñ–∞–π–ª–æ–≤
    MaxAge:     28,            // –¥–Ω–µ–π
    Compress:   true,          // gzip
}
```

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ

1. **–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ MaxSize:**
   - –¢–µ–∫—É—â–∏–π `bot.log` ‚Üí `bot.log.2025-01-15T12-34-56.000.gz`
   - –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π `bot.log`

2. **–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ MaxBackups:**
   - –£–¥–∞–ª—è–µ—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤

3. **–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ MaxAge:**
   - –£–¥–∞–ª—è—é—Ç—Å—è –∞—Ä—Ö–∏–≤—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ .env

```bash
# –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤ (lumberjack)
LOG_MAX_SIZE_MB=100      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ (MB)
LOG_MAX_BACKUPS=3        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤
LOG_MAX_AGE_DAYS=28      # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞—Ä—Ö–∏–≤–æ–≤ (–¥–Ω–∏)
```

### –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤

```
logs/
‚îú‚îÄ‚îÄ bot.log                              # –¢–µ–∫—É—â–∏–π –ª–æ–≥ (–∞–∫—Ç–∏–≤–Ω—ã–π)
‚îú‚îÄ‚îÄ bot.log.2025-01-14T10-30-00.000.gz  # –ê—Ä—Ö–∏–≤ 1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥
‚îú‚îÄ‚îÄ bot.log.2025-01-13T09-15-30.000.gz  # –ê—Ä—Ö–∏–≤ 2 –¥–Ω—è –Ω–∞–∑–∞–¥
‚îî‚îÄ‚îÄ bot.log.2025-01-12T08-45-15.000.gz  # –ê—Ä—Ö–∏–≤ 3 –¥–Ω—è –Ω–∞–∑–∞–¥
```

–ü–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏ (MaxBackups=3):
- –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π `bot.log`
- –°–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∞—Ä—Ö–∏–≤ —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –†–æ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL

### –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ `event_log`

–¢–∞–±–ª–∏—Ü–∞ `event_log` —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ –º–µ—Å—è—á–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏:

```sql
CREATE TABLE event_log (
    id BIGSERIAL NOT NULL,
    chat_id BIGINT NOT NULL,
    user_id BIGINT,
    module_name TEXT,
    action TEXT,
    details TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π

–ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–¥—É–ª–µ–º **Maintenance**:

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏—è –Ω–∞ –æ–∫—Ç—è–±—Ä—å 2025
CREATE TABLE IF NOT EXISTS event_log_2025_10 
PARTITION OF event_log
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

-- –ü–∞—Ä—Ç–∏—Ü–∏—è –Ω–∞ –Ω–æ—è–±—Ä—å 2025
CREATE TABLE IF NOT EXISTS event_log_2025_11 
PARTITION OF event_log
FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ó–∞–ø—Ä–æ—Å—ã —Å–∫–∞–Ω–∏—Ä—É—é—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:**
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `DROP TABLE` (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –±—ç–∫–∞–ø–æ–≤ (–ø–æ –ø–∞—Ä—Ç–∏—Ü–∏—è–º)

‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## –ú–æ–¥—É–ª—å Maintenance

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–§–æ–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ë–î:
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ retention policy

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (cron)

```go
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
"0 3 * * *" ‚Üí ensurePartitions()

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 04:00
"0 4 * * *" ‚Üí cleanupOldData()
```

### –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π

```go
func ensurePartitions() {
    currentMonth := time.Now()
    
    // –°–æ–∑–¥–∞—ë–º –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥
    for i := 0; i < 3; i++ {
        month := currentMonth.AddDate(0, i, 0)
        
        partitionName := fmt.Sprintf("event_log_%d_%02d", 
            month.Year(), month.Month())
        
        rangeStart := firstDayOfMonth(month)
        rangeEnd := firstDayOfMonth(month.AddDate(0, 1, 0))
        
        sql := `CREATE TABLE IF NOT EXISTS %s 
                PARTITION OF event_log 
                FOR VALUES FROM ('%s') TO ('%s')`
        
        db.Exec(sql, partitionName, rangeStart, rangeEnd)
    }
}
```

### –ê–ª–≥–æ—Ä–∏—Ç–º —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```go
func cleanupOldData() {
    retentionMonths := cfg.DBRetentionMonths // –∏–∑ .env
    
    cutoffDate := time.Now().AddDate(0, -retentionMonths, 0)
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ retention period
    rows := db.Query(`
        SELECT tablename FROM pg_tables 
        WHERE schemaname='public' 
        AND tablename LIKE 'event_log_%'
    `)
    
    for rows.Next() {
        var tableName string
        rows.Scan(&tableName)
        
        // –ü–∞—Ä—Å–∏–º –≥–æ–¥ –∏ –º–µ—Å—è—Ü –∏–∑ –∏–º–µ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ã
        partitionDate := parsePartitionDate(tableName)
        
        if partitionDate.Before(cutoffDate) {
            db.Exec("DROP TABLE IF EXISTS %s", tableName)
            logger.Info("dropped old partition", 
                zap.String("table", tableName))
        }
    }
}
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```bash
# ========================================
# –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤ (lumberjack)
# ========================================

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ –≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö
# –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –ª–æ–≥-—Ñ–∞–π–ª
LOG_MAX_SIZE_MB=100

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤
# –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
LOG_MAX_BACKUPS=3

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –ª–æ–≥–æ–≤ –≤ –¥–Ω—è—Ö
# –§–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ —ç—Ç–æ–≥–æ —Å—Ä–æ–∫–∞ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
LOG_MAX_AGE_DAYS=28

# ========================================
# –†–æ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
# ========================================

# –ü–µ—Ä–∏–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –º–µ—Å—è—Ü–∞—Ö
# event_log –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ —ç—Ç–æ–≥–æ —Å—Ä–æ–∫–∞ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
DB_RETENTION_MONTHS=6
```

### –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ `.env`:

```go
LogMaxSizeMB:        100,  // 100 MB –Ω–∞ —Ñ–∞–π–ª
LogMaxBackups:       3,    // 3 –∞—Ä—Ö–∏–≤–∞
LogMaxAgeDays:       28,   // 28 –¥–Ω–µ–π
DBRetentionMonths:   6,    // 6 –º–µ—Å—è—Ü–µ–≤
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**–ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (<1000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å):**
```bash
LOG_MAX_SIZE_MB=50
LOG_MAX_BACKUPS=2
LOG_MAX_AGE_DAYS=14
DB_RETENTION_MONTHS=3
```

**–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (1000-10000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å):**
```bash
LOG_MAX_SIZE_MB=100
LOG_MAX_BACKUPS=3
LOG_MAX_AGE_DAYS=28
DB_RETENTION_MONTHS=6
```

**–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (>10000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å):**
```bash
LOG_MAX_SIZE_MB=200
LOG_MAX_BACKUPS=5
LOG_MAX_AGE_DAYS=30
DB_RETENTION_MONTHS=12
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–∞
ls -lh logs/bot.log

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞—Ä—Ö–∏–≤—ã
ls -lh logs/

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–æ—Ç–∞—Ü–∏–∏
ls -lt logs/ | head -5
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–π –ë–î

```sql
-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π event_log
SELECT 
    tablename, 
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname='public' 
AND tablename LIKE 'event_log_%'
ORDER BY tablename DESC;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
SELECT 
    'event_log_2025_10' as partition,
    COUNT(*) as records
FROM event_log_2025_10
UNION ALL
SELECT 
    'event_log_2025_11',
    COUNT(*)
FROM event_log_2025_11
ORDER BY partition DESC;
```

### –õ–æ–≥–∏ –º–æ–¥—É–ª—è Maintenance

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–æ–¥—É–ª—è –º–æ–∂–Ω–æ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞:

```bash
# –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—è
grep "maintenance module started" logs/bot.log

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
grep "partition already exists or created" logs/bot.log

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
grep "dropped old partition" logs/bot.log

# –û—à–∏–±–∫–∏
grep -i "maintenance.*error" logs/bot.log
```

–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:

```
INFO    maintenance/maintenance.go:45   maintenance module started
INFO    maintenance/maintenance.go:78   partition already exists or created     {"partition": "event_log_2025_10"}
INFO    maintenance/maintenance.go:78   partition already exists or created     {"partition": "event_log_2025_11"}
INFO    maintenance/maintenance.go:78   partition already exists or created     {"partition": "event_log_2025_12"}
INFO    maintenance/maintenance.go:125  dropped old partition  {"table": "event_log_2024_04"}
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥-—Ñ–∞–π–ª –Ω–µ —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- `bot.log` –ø—Ä–µ–≤—ã—à–∞–µ—Ç `LOG_MAX_SIZE_MB`
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∞—Ä—Ö–∏–≤–Ω—ã–µ —Ñ–∞–π–ª—ã `.gz`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `logs/`:
   ```bash
   ls -ld logs/
   chmod 755 logs/
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–¥–µ:
   ```go
   // internal/logx/logx.go
   rotationCfg := cfg.LogRotationConfig
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:
   ```bash
   docker compose restart bot
   ```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤ `event_log`
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron:
   ```bash
   grep "maintenance module started" logs/bot.log
   ```

2. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é:
   ```sql
   -- –ü—Ä–∏–º–µ—Ä –¥–ª—è —è–Ω–≤–∞—Ä—è 2026
   CREATE TABLE IF NOT EXISTS event_log_2026_01 
   PARTITION OF event_log
   FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –º–æ–¥—É–ª—è Maintenance:
   ```bash
   grep "ensurePartitions" logs/bot.log
   ```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ `DB_RETENTION_MONTHS` –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç—ë—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `DB_RETENTION_MONTHS` –≤ `.env`:
   ```bash
   grep DB_RETENTION_MONTHS .env
   ```

2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é:
   ```sql
   -- –í–ù–ò–ú–ê–ù–ò–ï: –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!
   DROP TABLE IF EXISTS event_log_2024_06;
   DROP TABLE IF EXISTS event_log_2024_07;
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ cleanupOldData:
   ```bash
   grep "cleanupOldData" logs/bot.log
   ```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥–∏ –∑–∞–Ω–∏–º–∞—é—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `logs/` > 1 GB
- –ê—Ä—Ö–∏–≤—ã `.gz` –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–º–µ–Ω—å—à–∏—Ç—å `LOG_MAX_BACKUPS` –≤ `.env`:
   ```bash
   LOG_MAX_BACKUPS=2
   ```

2. –£–º–µ–Ω—å—à–∏—Ç—å `LOG_MAX_AGE_DAYS`:
   ```bash
   LOG_MAX_AGE_DAYS=14
   ```

3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –≤—Ä—É—á–Ω—É—é:
   ```bash
   find logs/ -name "bot.log.*.gz" -mtime +30 -delete
   ```

4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ event_log

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã `/chatstats`, `/topchat`
- –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `event_log`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:
   ```sql
   SELECT COUNT(*) FROM event_log;
   ```

2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:
   ```sql
   -- –£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤
   DROP TABLE IF EXISTS event_log_2024_06;
   DROP TABLE IF EXISTS event_log_2024_07;
   -- ... –∏ —Ç.–¥.
   ```

3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   ```sql
   REINDEX TABLE event_log;
   ```

4. –í—ã–ø–æ–ª–Ω–∏—Ç—å VACUUM:
   ```sql
   VACUUM ANALYZE event_log;
   ```

---

## üîó –°–º. —Ç–∞–∫–∂–µ

- [–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–æ—Ç–∞—Ü–∏–∏](ROTATION_QUICKREF.md) ‚Äî –±—ã—Å—Ç—Ä—ã–π reference
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î](../architecture/DATABASE.md) ‚Äî –¥–µ—Ç–∞–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- [–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π](../modules/MODULES.md) ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è Maintenance
- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](../QUICKSTART.md) ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025  
**–ü—Ä–æ–µ–∫—Ç:** BMFT (Better Moderation & Fun Tools)
