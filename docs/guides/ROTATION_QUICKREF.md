# üîÑ –†–æ—Ç–∞—Ü–∏—è ‚Äî –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞

–ë—ã—Å—Ç—Ä—ã–π reference –ø–æ —Å–∏—Å—Ç–µ–º–µ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```bash
# –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ (lumberjack)
LOG_MAX_SIZE_MB=100        # –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (MB)
LOG_MAX_BACKUPS=3          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä—Ö–∏–≤–æ–≤
LOG_MAX_AGE_DAYS=28        # –í–æ–∑—Ä–∞—Å—Ç –∞—Ä—Ö–∏–≤–æ–≤ (–¥–Ω–∏)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)
DB_RETENTION_MONTHS=6      # –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–º–µ—Å—è—Ü—ã)
```

---

## üìÅ –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏

### –ú–µ—Ö–∞–Ω–∏–∑–º
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** [lumberjack.v2](https://github.com/natefinch/lumberjack)
- **–°–∂–∞—Ç–∏–µ:** gzip
- **–ü—É—Ç—å:** `logs/bot.log`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
logs/
‚îú‚îÄ‚îÄ bot.log                              # –¢–µ–∫—É—â–∏–π
‚îú‚îÄ‚îÄ bot.log.2025-01-14T10-30-00.000.gz  # –ê—Ä—Ö–∏–≤ 1
‚îú‚îÄ‚îÄ bot.log.2025-01-13T09-15-30.000.gz  # –ê—Ä—Ö–∏–≤ 2
‚îî‚îÄ‚îÄ bot.log.2025-01-12T08-45-15.000.gz  # –ê—Ä—Ö–∏–≤ 3
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```bash
ls -lh logs/                  # –í—Å–µ —Ñ–∞–π–ª—ã
ls -lt logs/ | head -5        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏
du -sh logs/                  # –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```

---

## üóÑÔ∏è –†–æ—Ç–∞—Ü–∏—è –ë–î (–ø–∞—Ä—Ç–∏—Ü–∏–∏)

### –¢–∞–±–ª–∏—Ü–∞ event_log

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
PARTITION BY RANGE (created_at)
```

### –ü–∞—Ä—Ç–∏—Ü–∏–∏

```
event_log_2025_10    # –û–∫—Ç—è–±—Ä—å 2025
event_log_2025_11    # –ù–æ—è–±—Ä—å 2025
event_log_2025_12    # –î–µ–∫–∞–±—Ä—å 2025
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:** –ú–æ–¥—É–ª—å Maintenance (03:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)

**–í—Ä—É—á–Ω—É—é:**
```sql
CREATE TABLE IF NOT EXISTS event_log_2026_01 
PARTITION OF event_log
FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

### –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:** –ú–æ–¥—É–ª—å Maintenance (04:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)

**–í—Ä—É—á–Ω—É—é:**
```sql
-- –í–ù–ò–ú–ê–ù–ò–ï: –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!
DROP TABLE IF EXISTS event_log_2024_06;
```

---

## üîß –ú–æ–¥—É–ª—å Maintenance

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ

| –í—Ä–µ–º—è | –ó–∞–¥–∞—á–∞ | –§—É–Ω–∫—Ü–∏—è |
|-------|--------|---------|
| 03:00 | –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π | `ensurePartitions()` |
| 04:00 | –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö | `cleanupOldData()` |

### –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π

1. –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü + 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏
3. –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `CREATE TABLE ... PARTITION OF`

### –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è

1. –†–∞—Å—á—ë—Ç cutoff date: `NOW() - DB_RETENTION_MONTHS`
2. –ü–æ–∏—Å–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π —Å—Ç–∞—Ä—à–µ cutoff
3. –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `DROP TABLE`

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –õ–æ–≥–∏ –º–æ–¥—É–ª—è Maintenance

```bash
# –ó–∞–ø—É—Å–∫ –º–æ–¥—É–ª—è
grep "maintenance module started" logs/bot.log

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
grep "partition already exists or created" logs/bot.log

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
grep "dropped old partition" logs/bot.log
```

### SQL-–∑–∞–ø—Ä–æ—Å—ã

```sql
-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏—Ü–∏–π —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏
SELECT 
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname='public' AND tablename LIKE 'event_log_%'
ORDER BY tablename DESC;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏
SELECT COUNT(*) FROM event_log_2025_10;

-- –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä event_log (–≤—Å–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏)
SELECT pg_size_pretty(pg_total_relation_size('event_log'));
```

---

## üö® –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –õ–æ–≥-—Ñ–∞–π–ª –Ω–µ —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
ls -ld logs/
chmod 755 logs/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker compose restart bot
```

### –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

```sql
-- –°–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é
CREATE TABLE IF NOT EXISTS event_log_2026_01 
PARTITION OF event_log
FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
grep "ensurePartitions" logs/bot.log
```

### –°—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
grep DB_RETENTION_MONTHS .env

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
grep "cleanupOldData" logs/bot.log
```

### –õ–æ–≥–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞

```bash
# –£–º–µ–Ω—å—à–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ .env
LOG_MAX_BACKUPS=2
LOG_MAX_AGE_DAYS=14

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã
find logs/ -name "bot.log.*.gz" -mtime +30 -delete
```

---

## üìä –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
```bash
LOG_MAX_SIZE_MB=50
LOG_MAX_BACKUPS=2
LOG_MAX_AGE_DAYS=14
DB_RETENTION_MONTHS=3
```

### –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
```bash
LOG_MAX_SIZE_MB=100
LOG_MAX_BACKUPS=3
LOG_MAX_AGE_DAYS=28
DB_RETENTION_MONTHS=6
```

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
```bash
LOG_MAX_SIZE_MB=200
LOG_MAX_BACKUPS=5
LOG_MAX_AGE_DAYS=30
DB_RETENTION_MONTHS=12
```

---

## üîó –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

[ROTATION.md](ROTATION.md) ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–æ—Ç–∞—Ü–∏–∏

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025  
**–ü—Ä–æ–µ–∫—Ç:** BMFT (Better Moderation & Fun Tools)
