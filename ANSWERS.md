# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã + –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å

## ‚úÖ –û—Ç–≤–µ—Ç—ã:

### 01 - Webhook vs Long Polling
**–û—Ç–≤–µ—Ç:** –ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Long Polling** (–∫–∞–∫ –≤ Python –≤–µ—Ä—Å–∏–∏).

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ:** Webhook —Ç—Ä–µ–±—É–µ—Ç:
- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ–º–µ–Ω —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
- Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ç–≤–æ–π URL
- –ú–µ–Ω—å—à–µ latency, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ setup

Long Polling (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥):
- –ë–æ—Ç —Å–∞–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É Telegram
- –ù–µ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ–º–µ–Ω
- –ü—Ä–æ—â–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –¥–µ–ø–ª–æ—è
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–≤–æ–µ–≥–æ RPS (~0.004)

### 02 - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î
**–û—Ç–≤–µ—Ç:** ‚úÖ –°–æ–∑–¥–∞–Ω–∞ **–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞** –≤ `migrations/001_initial_schema.sql`

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **–ï–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `messages`** –≤–º–µ—Å—Ç–æ `{chat_id}` —Ç–∞–±–ª–∏—Ü
   - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ (messages_2025_10, messages_2025_11, etc.)
   - –õ–µ–≥—á–µ –¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
   - –ü—Ä–æ—â–µ –±—ç–∫–∞–ø—ã

2. **–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `limiter_config`**
   - –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ = –æ–¥–∏–Ω –ª–∏–º–∏—Ç
   - –ù–µ 12 –∫–æ–ª–æ–Ω–æ–∫ (audio, photo, video...), –∞:
     ```sql
     {chat_id, user_id, content_type, daily_limit}
     ```

3. **–¢–∞–±–ª–∏—Ü–∞ `chat_modules`** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è–º–∏
   - –ö–∞–∂–¥—ã–π —á–∞—Ç –≤–∫–ª—é—á–∞–µ—Ç –Ω—É–∂–Ω—ã–µ –º–æ–¥—É–ª–∏
   - `config JSONB` –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥—É–ª—è

4. **–¢–∞–±–ª–∏—Ü–∞ `chat_admins`** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏
   - –ê–¥–º–∏–Ω—ã —á–∞—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –ª–∏–º–∏—Ç—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ
   - –ù–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ –≤ –ª–∏—á–∫—É

### 03 - Scheduled tasks
**–û—Ç–≤–µ—Ç:** ‚úÖ –°–æ–∑–¥–∞–Ω **–º–æ–¥—É–ª—å Scheduler**

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- Cron-–∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ `github.com/robfig/cron/v3`
- –¢–∞–±–ª–∏—Ü–∞ `scheduler_tasks` —Å –ø–æ–ª—è–º–∏:
  - `cron_expression`: `"0 9 * * *"` (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00)
  - `task_type`: `"sticker"`, `"text"`, `"poll"`
  - `task_data`: JSONB —Å file_id —Å—Ç–∏–∫–µ—Ä–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º
- –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: `/addtask`, `/listtasks`, `/deltask`

**–ü—Ä–∏–º–µ—Ä –∏–∑ Python:**
```python
# scheduletask.py
schedule.every().day.at("09:00").do(send_sticker, chatid, sticker_id)
```

**–ê–Ω–∞–ª–æ–≥ –≤ Go:**
```go
// internal/modules/scheduler/cron.go
c := cron.New()
c.AddFunc("0 9 * * *", func() {
    sendSticker(chatID, stickerID)
})
c.Start()
```

### 04 - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
**–û—Ç–≤–µ—Ç:** ‚úÖ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω ‚Äî **8 —Ñ–∞–∑, 15-20 –¥–Ω–µ–π**

**MVP (7-10 –¥–Ω–µ–π):**
- –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤—ã–π –∫–∞—Ä–∫–∞—Å (–±–µ–∑ Kafka, telebot.v3)
- –§–∞–∑–∞ 2: –ú–æ–¥—É–ª—å Limiter (–ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç)
- –§–∞–∑–∞ 3: –ú–æ–¥—É–ª—å Reactions (—Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–ª–æ–≤–∞)
- –§–∞–∑–∞ 4: –ú–æ–¥—É–ª—å Statistics (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

**Full (12-16 –¥–Ω–µ–π):**
- –§–∞–∑–∞ 5: –ú–æ–¥—É–ª—å Scheduler (–∑–∞–¥–∞—á–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)
- –§–∞–∑–∞ 7: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã)

**Production (15-20 –¥–Ω–µ–π):**
- –§–∞–∑–∞ 8: –ú–µ—Ç—Ä–∏–∫–∏, CI/CD, –±—ç–∫–∞–ø—ã

### 05 - –ê–¥–º–∏–Ω–∫–∞
**–û—Ç–≤–µ—Ç:** ‚úÖ –ü–æ–∫–∞ **–∫–æ–º–∞–Ω–¥—ã –≤ Telegram**

**–ë—É–¥—É—â–µ–µ:** Telegram Mini App (WebView)
- –≠—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –≤–Ω—É—Ç—Ä–∏ Telegram
- –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å React/Vue
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º
- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

---

## üß© –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å: Plugin-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è "–ö–∞—Ä–∫–∞—Å + –ü–ª–∞–≥–∏–Ω—ã"

```
–Ø–î–†–û (Core Framework)
‚îú‚îÄ‚îÄ Bot initialization
‚îú‚îÄ‚îÄ Module registry
‚îú‚îÄ‚îÄ Message routing
‚îî‚îÄ‚îÄ Database layer

–ü–õ–ê–ì–ò–ù–´ (Modules)
‚îú‚îÄ‚îÄ Limiter        ‚Üê –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å per chat
‚îú‚îÄ‚îÄ Reactions      ‚Üê –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å per chat
‚îú‚îÄ‚îÄ AntiSpam       ‚Üê –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å per chat
‚îú‚îÄ‚îÄ Statistics     ‚Üê –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å per chat
‚îú‚îÄ‚îÄ Scheduler      ‚Üê –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å per chat
‚îî‚îÄ‚îÄ Custom Module  ‚Üê —Ç–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

#### 1. –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å = –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```go
type Module interface {
    Name() string                                  // "limiter"
    Description() string                           // "–õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç"
    Init(deps *ModuleDependencies) error          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    OnMessage(ctx *MessageContext) error          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    Commands() []Command                           // –ö–æ–º–∞–Ω–¥—ã –º–æ–¥—É–ª—è
    Shutdown() error                               // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
}
```

#### 2. –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π per chat

```sql
-- –¢–∞–±–ª–∏—Ü–∞ chat_modules
chat_id  | module_name | is_enabled | config
---------+-------------+------------+------------------------
-1001... | limiter     | true       | {"max_warnings": 3}
-1001... | reactions   | true       | {}
-1001... | antispam    | false      | {"threshold": 5}
36382... | limiter     | true       | {}
36382... | reactions   | false      | {}
```

**–ö–æ–º–∞–Ω–¥—ã:**
```
/modules                    # –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏
/modules enable limiter     # –≤–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å limiter
/modules disable antispam   # –≤—ã–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å antispam
```

#### 3. –ú–æ–¥—É–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã

**–ü–ª–æ—Ö–æ–π –ø–æ–¥—Ö–æ–¥ (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å):**
```go
// ‚ùå –ú–æ–¥—É–ª—å reactions –∑–∞–≤–∏—Å–∏—Ç –æ—Ç limiter
func (r *ReactionsModule) OnMessage(ctx *MessageContext) error {
    limit := ctx.Limiter.GetLimit(...) // –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å!
}
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å):**
```go
// ‚úÖ –ú–æ–¥—É–ª–∏ –Ω–µ –∑–Ω–∞—é—Ç –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ
func (r *ReactionsModule) OnMessage(ctx *MessageContext) error {
    // –ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º –ø–æ —Å–µ–±–µ
    // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î, –Ω–µ –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
}
```

#### 4. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è = 5 —à–∞–≥–æ–≤

**–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞—ë–º –º–æ–¥—É–ª—å "Captcha" –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤**

**–®–∞–≥ 1:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
```bash
mkdir -p internal/modules/captcha
touch internal/modules/captcha/{module.go,service.go,repository.go,commands.go}
```

**–®–∞–≥ 2:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Module
```go
// internal/modules/captcha/module.go
package captcha

type CaptchaModule struct {
    name string
    // ...
}

func New() *CaptchaModule {
    return &CaptchaModule{name: "captcha"}
}

func (m *CaptchaModule) Name() string { return m.name }
func (m *CaptchaModule) Init(...) error { /* ... */ }
func (m *CaptchaModule) OnMessage(...) error {
    // –õ–æ–≥–∏–∫–∞ –∫–∞–ø—á–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
}
func (m *CaptchaModule) Commands() []Command {
    return []Command{
        {Command: "/setcaptcha", Handler: m.handleSetCaptcha},
    }
}
```

**–®–∞–≥ 3:** –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è)
```sql
-- migrations/002_add_captcha.sql
CREATE TABLE captcha_config (
    chat_id BIGINT PRIMARY KEY,
    captcha_type VARCHAR(20), -- 'math', 'button', 'image'
    timeout_seconds INT DEFAULT 60,
    ban_on_failure BOOLEAN DEFAULT false
);
```

**–®–∞–≥ 4:** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
```go
// cmd/bot/main.go
registry.Register(limiter.New())
registry.Register(reactions.New())
registry.Register(captcha.New()) // <- –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å
```

**–®–∞–≥ 5:** –ì–æ—Ç–æ–≤–æ! –ú–æ–¥—É–ª—å –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ `/modules enable captcha`

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

**–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ event_log
SELECT * FROM event_log WHERE event_type = 'limit_exceeded';
SELECT * FROM event_log WHERE module_name = 'antispam';
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥—É–ª—è–º:**
```sql
-- –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª limiter –∑–∞ –Ω–µ–¥–µ–ª—é?
SELECT COUNT(*) FROM event_log 
WHERE module_name = 'limiter' 
AND created_at > NOW() - INTERVAL '7 days';

-- –ö–∞–∫–∏–µ –º–æ–¥—É–ª–∏ —Å–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ?
SELECT module_name, COUNT(*) as events
FROM event_log
GROUP BY module_name
ORDER BY events DESC;
```

**–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:**
```sql
-- messages —Ç–∞–±–ª–∏—Ü–∞ ‚Äî –µ–¥–∏–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤
-- –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫—Ä–æ—Å—Å-—á–∞—Ç–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É

-- –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—ã:
SELECT EXTRACT(HOUR FROM created_at) as hour, COUNT(*)
FROM messages
GROUP BY hour
ORDER BY hour;

-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
SELECT content_type, COUNT(*)
FROM messages
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY content_type;

-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º:
SELECT u.username, COUNT(m.id) as msg_count
FROM messages m
JOIN users u ON u.user_id = m.user_id
GROUP BY u.username
ORDER BY msg_count DESC
LIMIT 10;
```

---

## üì¶ –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è —á–µ—Ä–µ–∑ JSONB

```sql
-- –ú–æ–¥—É–ª—å limiter —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
INSERT INTO chat_modules (chat_id, module_name, is_enabled, config) VALUES
(-1001637543078, 'limiter', true, '{
  "max_warnings": 3,
  "reset_warnings_after_hours": 24,
  "vip_users": [36382182, 227345104]
}');

-- –ú–æ–¥—É–ª—å antispam —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
INSERT INTO chat_modules (chat_id, module_name, is_enabled, config) VALUES
(-1001637543078, 'antispam', true, '{
  "flood_threshold": 5,
  "flood_window_seconds": 10,
  "ban_duration_seconds": 3600,
  "whitelist_domains": ["github.com", "stackoverflow.com"]
}');
```

**–ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ –º–æ–¥—É–ª–µ:**
```go
func (m *AntiSpamModule) OnMessage(ctx *MessageContext) error {
    config, _ := ctx.GetChatConfig(m.name)
    
    floodThreshold := config["flood_threshold"].(float64) // 5
    whitelistDomains := config["whitelist_domains"].([]interface{})
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}
```

---

## üöÄ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Telegram Bot API                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ Long Polling
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Core Framework (–Ø–¥—Ä–æ)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Module Registry                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - RegisterModule()                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - GetActiveModules(chatID)                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ - RouteMessage(message) ‚Üí []Module                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Message Router                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ For each active module:                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   module.OnMessage(context)                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚ñº                ‚ñº                ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Limiter ‚îÇ    ‚îÇReactions‚îÇ    ‚îÇ AntiSpam ‚îÇ    ‚îÇ Custom   ‚îÇ
‚îÇ Module  ‚îÇ    ‚îÇ Module  ‚îÇ    ‚îÇ Module   ‚îÇ    ‚îÇ Module   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ              ‚îÇ              ‚îÇ               ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ   PostgreSQL    ‚îÇ
            ‚îÇ  - messages     ‚îÇ
            ‚îÇ  - chat_modules ‚îÇ
            ‚îÇ  - limiter_*    ‚îÇ
            ‚îÇ  - reactions_*  ‚îÇ
            ‚îÇ  - event_log    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
1. **–û–¥–∏–Ω message ‚Üí –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ)
2. **–ú–æ–¥—É–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç –∫–æ–º–∞–Ω–¥—ã** ‚Üí –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
3. **–í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ per chat** ‚Üí –∞–¥–º–∏–Ω —á–∞—Ç–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç
4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞** ‚Üí –≤—Å–µ –≤ –æ–¥–Ω–æ–π –ë–î
5. **–ù–æ–≤—ã–π –º–æ–¥—É–ª—å = +1 —Ñ–∞–π–ª –≤ registry** ‚Üí –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ core

---

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

–°–æ–∑–¥–∞–Ω–æ:
- ‚úÖ SQL —Å—Ö–µ–º–∞: `migrations/001_initial_schema.sql`
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `ARCHITECTURE.md`
- ‚úÖ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏: `MIGRATION_PLAN.md`
- ‚úÖ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã: —ç—Ç–æ—Ç —Ñ–∞–π–ª

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –§–∞–∑–∞ 1 ‚Äî –ë–∞–∑–æ–≤—ã–π –∫–∞—Ä–∫–∞—Å**

–ù–∞—á–∏–Ω–∞–µ–º —É–¥–∞–ª—è—Ç—å Kafka –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å core framework?
